<html>
  <head>

    <!-- Meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Manos a la Obra</title>

    <!-- CSS Imports -->
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css"
          integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="style.css">
    
  </head>
  
  <body>

    <div class="jumbotron-wrapper">
    <div class="jumbotron">
      
      <a target="_blank" href="https://www.facebook.com/manosalaobrasismo/">
        <img src="logo.jpeg" alt="logo" class="logo" />
      </a>

      <h1 class="display-3 text-white">
        <b>Manos a la Obra</b>
      </h1>
      
      <p class="lead text-white">Coordinación de ayuda para los sismos de 2017 en México</p>
      
      <hr class="my-4">
      
      <p class="text-white">Por favor llena la encuesta con tus datos y la ayuda que necesitas o puedes ofrecer. ¡Ayúdanos a compartir ayuda!</p>

      <p class="lead text-center">

        <a class="btn btn-primary btn-lg border"
           target="_blank"
           href="https://tinyurl.com/ayudasismo2017"
           role="button">Pide/ofrece ayuda</a>
       
      
      </p>
      
      <p class="lead text-center">

        <a class="btn btn-info btn-sm border"
           target="_blank"
           href="https://tinyurl.com/sismo2017ayudadatos"
           role="button">Accede a la base de datos</a>

        

      </p>

    </div>
    </div>

    <style>
        .mapboxgl-popup {
        z-index: 4;
        max-width: 400px;
        font: 10px/18px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        border-radius: 3px;
        width: 200px;
        border: 1px solid rgba(0.5,0.5,0.5,0.4);
        background-color: #FAFAFA;
        }
        .comida{
            width: 10px;
            height: 10px;
        }
    </style>



    <div class="container-fluid">

      <div class="row">

        <div class="col-md-8">

          <div class="alert alert-info" role="alert">
              
              <i class="fa fa-handshake-o" aria-hidden="true"></i>

              <strong id="offeringHelpCount">1173+</strong>
              ofertas de ayuda
              
              <i class="fa fa-hand-paper-o" aria-hidden="true"></i>

              <strong id="needingHelpCount">201+</strong>
              solicitudes de ayuda
          
          </div>


          

          <div style="height:20px"></div>
          <div class="card border-0" id="offerOrNeedContent">
          <!Stuff for map>
          <html>
          <head>
          <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
          <script src="https://www.google.com/jsapi"> </script>
          <script src="https://www.google.com/uds/modules/gviz/gviz-api.js"></script>
          <script type="text/javascript" src="https://www.google.com/jsapi"></scriptpt type="text/javascript" src="https://www.google.com/jsapi"></script>
          <script src="http://code.jquery.com/jquery-1.10.1.min.js"> </script>
          <script src="./js/papaparse.min.js"></script>
          <script src="./js/taffy-min.js"></script>
          <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
          <script src="multiselect/js/jquery.bootstrap.treeselect.js"></script>

          <meta charset='utf-8' />
          <title></title>
          <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
          <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
          <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.0/mapbox-gl.js'></script>
          <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.1/mapbox-gl.css' rel='stylesheet' />

         <style>
            .mapboxgl-popup-content {
                overflow-y: scroll;
                overflow-x: scroll;
          }
         </style>

                <div class="card-body">
                   <style>
                   #menu {
                      overflow: hidden;
                      background: #fff;
                      position: absolute;
                      top: 20px;
                      right: 22px;
                      z-index: 2;
                      border-radius: 2px;
                      width: 140px;
                      border: 1px solid rgba(0,0,0,0.4);
                      font-family: 'Open Sans', sans-serif;
                   }
                  
                  #menu a {
                      font-size: 12px;
                      color: #404040;
                      display: block;
                      z-index: 2;
                      margin: 0;
                      padding: 01px;
                      text-decoration: none;
                      border-bottom: 1px solid rgba(0,0,0,0.25);
                      text-align: center;
                 }

                 #menu a:last-child {
                       border: none;
                  }

                 #menu a:hover {
                    background-color: #f8f8f8;
                    color: #404040;
                  } 

                 #menu a.active {
                    background-color: #3887be;
                    color: #ffffff;
                 }

                 #menu a.active:hover {
                    background: #3074a4;
                 }
                 </style>
                  <style>
                  #mapa { 
                     top:00; 
                     bottom:00; 
                     width:100%; 
                     padding: 0px;
                     height: 100vh;
                     max-height: auto;
                     z-index = 1;
                     }
                   </style>
                   <style>
                   .marker {
                      background-size: cover;
                      width: 5px;
                      height: 5px;
                      border-radius: 50%;
                      cursor: pointer;
                      background-image: url("agua_rojo.png");
                   }
                   </style>

                <div id="mapa">
                  <div id="menu" style="left:0;"> </div>
                  <script src="./mapa.js"></script>
                  <script> createdatabase(mapa,menu) </script>
                 </div>

                </div>
          
              </div>

        </div>
        
        <div class="col-md-4">

          <div class="input-group input-group-lg"
               id="searchBarComponent">

            <span class="input-group-addon" id="sizing-addon1">
              <i class="fa fa-search" aria-hidden="true"></i>
            </span>
            
            <input type="text"
                  id="searchInput"
                  class="form-control"
                  placeholder="buscar..."
                  aria-describedby="sizing-addon1">

          </div>

          <div class="list-group" id="searchBarResults">
            <!-- Example of one div that would lie in this when searching -->
            <!-- <a href="#" class="list-group-item list-group-item-action">Dapibus ac facilisis in</a> -->
          </div>

          <!-- TODO: Hack to make this card start at 
                     same vertical align as maps card -->
          <div style="height:57px"></div>
              
          <div class="card" id="sideInfoCard">
            
            <div class="card-body">
            
              <h4 class="card-title">
                ¿No sabes qué hacer? ¡Ayúdanos!
              </h4>

              <p class="card-text">
                Sal a la calle y reporta en esta página la ayuda requerida por otras personas. No todos tienen internet. Pon los datos de contacto de la persona que necesita/ofrece ayuda.
              </p>
            
              <p class="card-text">
                Busca gente que necesita ayuda en la base de datos que está cerca de ti. Ayúdalos.
              </p>
            
              <p class="card-text">
                Si sabes de algún grupo real que necesite ayuda, añádelo a la base de datos. Responde Necesito a la primera pregunta y añade los datos de contacto de la organización.
              </p>
            
              <p class="card-text">
                Mucha gente que necesita ayuda no tiene manera de informar a los demás. Por favor contáctalos con los voluntarios en la lista.
              </p>
            
              <p class="card-text">
                Contacta con la gente pidiendo ayuda fuera de las grandes ciudades. Ellos no están recibiendo tanta atención.
              </p>
            
              <p class="card-text">
                Recuerda que esta información no sirve de nada si no nos conectamos y llevamos la ayuda a quien la necesite.
              </p>
           
              <a class="btn btn-primary btn-block"
                 target="_blank" 
                 href="https://www.facebook.com/sharer/sharer.php?u=http://manosalaobrasismo.mx/">
               <i class="fa fa-facebook-official fa-lg" aria-hidden="true"></i>
               Compartir Manos a la Obra
             </a>
            
              <a class="btn btn-primary btn-block"
                 target="_blank" 
                 href="https://twitter.com/home?status=Manos%20a%20la%20Obra%3A%20Coordinaci%C3%B3n%20de%20ayuda%20para%20el%20sismo%20en%20M%C3%A9xico%20http%3A//www.manosalaobrasismo.mx%20%23manosalaobra">

               <i class="fa fa-twitter fa-lg" aria-hidden="true"></i>
               Tweet Manos a la Obra
             </a>
            
            </div>
          
          </div>
        
        </div>
      
      </div>
    
    </div>

    <div class="container-fluid">
      
      <div class="card border-0">
        
        <div class="card-body">
          
          <p class="card-text small">
            Somos un grupo de habitantes del internet mexicanos que vive por todo México y Estados Unidos.
          </p>  

          <p class="card-text small">
            Nos conocimos en el Department of Urban Studies and Planning del MIT y la Harvard Graduate School of Design. Nuestro esfuerzo que ya suma a más de 20 personas totalmente voluntarias y sin ningún ingreso económico ni afán de apropiación <a target="_blank" href="https://github.com/manos-a-la-obra/">de nada</a>.
          </p>

          <p class="card-text small">
            Nuestro equipo está compuesto de planeadores urbanos, arquitectos, programadores, físicos, químicos, expertos en redes sociales, managers entre otros.
          </p>

          <p class="card-text small">
            Estamos trabajando muy duro en esfuerzos de captura, software, comprobación, seguimiento y coordinación de ayuda. Todos los datos que trabajamos están abiertos y queremos dar transparencia y claridad a todos nuestros procesos. Los datos no sirven si la ayuda no es entregada en tiempo y forma.
          </p>

          <p class="card-text small">
            Mil abrazos a todos los que perdieron todo y a los que están rompiéndose la espalda en las calles. Estamos trabajando por ustedes.
          </p>
                    
          <p class="card-text small">
            Si quieres ayudarnos a organizar y distribuir la ayuda o tienes alguna duda, únete a <a target="_blank" href="https://www.facebook.com/groups/494018237616873/">este grupo</a>.
          </p>

          <p class="card-text small">
            2017
          </p>
          
        </div>
      
      </div>
    
    </div>
    
    <!-- JS library imports at end so page loads faster -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
            integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" 
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"
            integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script>

    <script type="text/javascript">

      /*!
       * IE10 viewport hack for Surface/desktop Windows 8 bug
       * Copyright 2014-2017 The Bootstrap Authors
       * Copyright 2014-2017 Twitter, Inc.
       * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
       */

      // See the Getting Started docs for more information:
      // https://getbootstrap.com/getting-started/#support-ie10-width
      (function () {
        'use strict'

        if (navigator.userAgent.match(/IEMobile\/10\.0/)) {
          var msViewportStyle = document.createElement('style')
          msViewportStyle.appendChild(
            document.createTextNode(
              '@-ms-viewport{width:auto!important}'
            )
          )
          document.head.appendChild(msViewportStyle)
        }

      }());

      // $('#element').donetyping(callback[, timeout=1000])
      // Fires callback when a user has finished typing. This is determined by the time elapsed
      // since the last keystroke and timeout parameter or the blur event--whichever comes first.
      //   @callback: function to be called when even triggers
      //   @timeout:  (default=1000) timeout, in ms, to to wait before triggering event if not
      //              caused by blur.
      // Requires jQuery 1.7+
      (function($){
          $.fn.extend({
              donetyping: function(callback,timeout){
                  timeout = timeout || 1e3/4; // 0.25 second default timeout
                  var timeoutReference,
                      doneTyping = function(el){
                          if (!timeoutReference) return;
                          timeoutReference = null;
                          callback.call(el);
                      };
                  return this.each(function(i,el){
                      var $el = $(el);
                      // Chrome Fix (Use keyup over keypress to detect backspace)
                      // thank you @palerdot
                      $el.is(':input') && $el.on('keyup keypress paste', function(e){
                          // This catches the backspace button in chrome, but also prevents
                          // the event from triggering too preemptively. Without this line,
                          // using tab/shift+tab will make the focused element fire the callback.
                          if (e.type=='keyup' && e.keyCode!=8) return;
                          
                          // Check if timeout has been set. If it has, "reset" the clock and
                          // start over again.
                          if (timeoutReference) clearTimeout(timeoutReference);
                          timeoutReference = setTimeout(function(){
                              // if we made it here, our timeout has elapsed.
                              // Fire the callback.
                              doneTyping(el);
                          }, timeout);
                      }).on('blur',function(){
                          // If we can, fire the event since we're leaving the field
                          doneTyping(el);
                      });
                  });
              }
          });
      })(jQuery);

      // TODO: This is a hack, can it be resolved in CSS?
      (function () {

        // Adjust maximum map div height to match left card's height
        var sideChartHeight = $('#sideInfoCard').height();
        // Use the smaller of these two options
        var useHeight = sideChartHeight > 900 ? 900 : sideChartHeight;
        $('#offerOrNeedContent').height(useHeight + 50);

      }());

      // Udpate how we deal with String protos
      String.prototype.toProperCase = function () {
        var cleaned = this.split(' ');
        cleaned = cleaned.map(function (ea) {
          return ea.replace(/\w\S*/g, function(txt){
            return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
          });
        })
        return cleaned.join(' ');
      };

    </script>

    <script type="text/javascript">

      // Globals
      var entries = [];
      var dataUrl = 'https://spreadsheets.google.com/feeds/list/1vHrM6r3sO1f6ylsci_B7z08PrLsYKpG5VywjZXD6l5M/1/public/values?alt=json';

      $('#searchInput').donetyping(function () {
        var content = $('#searchInput').val().toLowerCase();

        if (content.length < 3) {
          $('#searchBarResults').empty();
          return null;
        
        } else {
          var possibleEntries = entries.filter(function (ea) {
            var keys = Object.keys(ea);
            var anyValid = keys.filter(function (k) {
              if (typeof ea[k] !== 'string') {
                return false;
              }
              var lower = ea[k].toLowerCase();
              return lower.indexOf(content) > -1;
            });
            return anyValid.length > 0;
          });

          updateSearchresultsList(possibleEntries.reverse().slice(0,5)); 
        }
      });

      function updateSearchresultsList (e) {
        var searchRes = $('#searchBarResults');
        searchRes.empty();

        // Make a note that gets added if there are no valid results
        if (e.length == 0) {
          searchRes.append(`
            <li class="list-group-item list-group-item-action">
              <i class="fa fa-meh-o" aria-hidden="true"></i>
              <strong>
                No hay resultados.
              </strong>
            </li>
          `);
        }

        e.forEach(function (ea) {
          var level = ea.needsHelp ? 'danger' : 'success';
          var icon = ea.needsHelp ? 'fa-hand-paper-o' : 'fa-handshake-o';

          var phoneHTML = `
            <br>
            <small>
              <i class="fa fa-whatsapp" aria-hidden="true"></i>
              ${ea.telephone}
            </small>
          `
          var phoneInfo = ea.telephone ? phoneHTML : '';

          var fullAddress = ea.address ? ea.address : ea.geocoded;
          var altAddress = [ea.colonia,
                            ea.ciudad,
                            ea.postal].filter(function (ea) {
                              return ea
                            }).join(', ').toProperCase();

          searchRes.append(`
            <li class="list-group-item list-group-item-${level}">

              <i class="fa ${icon}" aria-hidden="true"></i>
              <strong>
                ${ea.nombre.toProperCase()}
              </strong>

              ${phoneInfo}

              <br>

              <small>
                <i class="fa fa-map-marker" aria-hidden="true"></i>
                ${!fullAddress ? fullAddress : altAddress}
              </small>

              <hr class="my-2">

              <small>
                ${ea.details.toProperCase()}
              </small>
              
              <br>

            </li>
          `);
        });

        return null;
      }

      $.get(dataUrl)
        .then(function(response) {
          // Skip the first few entries which are the headers
          entries = response.feed.entry.slice(3,);
          
          entries = entries.map(function (ea) {
            return {
              // Location aspects
              'address': ea.gsx$addressbot.$t.trim(),
              'geocoded': ea.gsx$geocoding.$t.trim(),
              'colonia': ea.gsx$colonia.$t.trim(),
              'ciudad': ea.gsx$ciudad.$t.trim(),
              'municipality': ea.gsx$delegaciónmunicipio.$t.trim(),
              'estado': ea.gsx$estado.$t.trim(),
              'postal': ea.gsx$códigopostal.$t.trim(),

              // Attempted

              // Social aspects
              'facebook': ea.gsx$facebookpontuhandleounlinkrecuerdaquemuchosnombresestánrepetidosenfacebook.$t.trim(),
              'twitter': ea.gsx$twitter.$t.trim(),
              'telephone': ea.gsx$teléfonowhatsapp.$t.trim(),

              // Identification
              'nombre': ea.gsx$nombresieresmiembrodeunaorganizacióntambiénponsunombre.$t.trim(),

              // Offering or receiving
              'needsHelp': (ea.gsx$ofrezconecesito.$t !== 'Ofrezco'),
              'position': ea.gsx$ofrezconecesito.$t.trim(),
              'details': ea['gsx$quéofrezconecesitocomidahospedajeaguatransporteperitajesetc.-porfavorofreceayudaprofesionalasistenciamédicaperitajessieresunprofesionaleneltema'].$t.trim(),
            }
          });

          var inNeed = entries.filter(function (ea) {
            return ea.needsHelp;
          });
          $('#needingHelpCount').html(`${inNeed.length}+`);

          var offeringHelp = entries.filter(function (ea) {
            return !ea.needsHelp;
          });
          $('#offeringHelpCount').html(`${offeringHelp.length}+`);


        })
        .fail(function(error) {
          console.log('Unable to get Google FusionTable data.', error);
          $('#searchBarComponent').hide();
        });

    </script>

    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-106900721-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments)};
      gtag('js', new Date());

      gtag('config', 'UA-106900721-1');
    </script>

  </body>
</html>
