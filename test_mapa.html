<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="https://www.google.com/jsapi"> </script>
<script src="https://www.google.com/uds/modules/gviz/gviz-api.js"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></scriptpt type="text/javascript" src="https://www.google.com/jsapi"></script>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"> </script>
<script src="./.js/papaparse.min.js"></script>
<script type="text/javascript" src="./.js/taffy-min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<script src="multiselect/js/jquery.bootstrap.treeselect.js"></script>

    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.0/mapbox-gl.css' rel='stylesheet' />
    <style>
      body {
        margin: 0;
        padding: 0;
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
    </style>
</head>
<body>

<div id='map_container'>
	<div id='controls' style="z-index: 1; position: absolute; top: 0px; left: 0px;">
			<input type="radio" name="filter" id="all" value="all" /><label for="all">Ver todo</label>
		    </br>
		    <input type="radio" name="filter" id="ofrezco" value="Ofrezco" /><label for="ofrezco">Ofrezco</label>
		    </br>
		    <input type="radio" name="filter" id="necesito" value="Necesito" /><label for="necesito">Necesito</label>
		    </br>
		    <input type="radio" name="filter" id="manos" value="Ofrezco" /><label for="manos">Manos/voluntarios</label>
		    </br>
  		</ul>
	</div>
	<div id='map'></div>
</div>

<script>

mapboxgl.accessToken = 'pk.eyJ1IjoiYnV6b2hlcmJlcnQiLCJhIjoibXJXclpEVSJ9.YxiPmO7Q5QZrOGCuOsAYQg';

var map = new mapboxgl.Map({
  container: 'map',	
  style: 'mapbox://styles/buzoherbert/cj827abvc9bnr2rmscyivgxpb',
  center: [-96, 37.8],
  zoom: 3
});
map.on('load', function () {

    map.addLayer({
        "id": "points",
        "type": "symbol",
        "source": {
            "type": "geojson",
            "data": {
                "type": "FeatureCollection",
                "features": [{
                    "type": "Feature",
                    "geometry": {
                        "type": "Point",
                        "coordinates": [-77.03238901390978, 38.913188059745586]
                    },
                    "properties": {
                        "title": "Mapbox DC",
                        "icon": "monument"
                    },
                    "___id": "points",
                }, 


{
                    "type": "Feature",
                    "geometry": {
                        "type": "Point",
                        "coordinates": [-122.414, 37.776]
                    },
                    "properties": {
                        "title": "Mapbox SF",
                        "icon": "harbor"
                    }
                }]
            }
        },
        "layout": {
            "icon-image": "{icon}-15",
            "text-field": "{title}",
            "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
            "text-offset": [0, 0.6],
            "text-anchor": "top"
        }
    });
});


var data_base;

function createdatabase(){
    getting_db();
}


function getTableData(key,cat,callback){
    getting_db().then(callback(key,cat));
}

function call_ll(){
    console.log(typeof data_base)
    var myJSON = JSON.stringify(data_base({"comida":{is:true}}).get());
    console.log(myJSON);
    return;
}

function getting_db(){
    // Document
    // directamente por tabla
    var googlesheet = "https://docs.google.com/spreadsheets/d/1vHrM6r3sO1f6ylsci_B7z08PrLsYKpG5VywjZXD6l5M/gviz/tq?tq=select%20A%20B%20C%20R%20S%20T&sheet={Form Responses 1}"

   // Loading everything
   google.load('visualization', '1.0', {
             callback:function(){
             var query = new google.visualization.Query(googlesheet);
             query.setQuery("SELECT *"); 
             query.send(handleQueryResponse);
             }
   })
   }

function handleQueryResponse(response){
       if (response.isError()) {
            alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
        }
        var data = response.getDataTable();
        var db = TAFFY();
        var parseRow = wrapper_parseRow(data,db);
        var csv = google.visualization.dataTableToCsv(data);

        // Here Papa parse show up
        var csv_parsed = Papa.parse(csv,{download:false,
                  step: function(row){
                      parseRow(row);
                  },
                  complete: function() {
                          create_selectors(db);
                          console.log("All results");
                 }});
        }


function create_selectors(db){
    var myJSON = JSON.stringify(db({"asistenciamedica":{is:true}}).select("geojson"));
    console.log(myJSON);
    //var keys_true = {is:true}
    //var keys = {"Necesito":keys_true}
    //create_botton("Necesito",db,keys);
}

function create_botton(value,db,keys){
     // Here que charge options
     var boton = document.createElement("button");
     boton.type = "button";
     boton.value = "Clic";
     document.body.appendChild(boton);
     function map_render(){
          separate_data(db,keys);
     }
     if (boton.addEventListener) {
        boton.addEventListener('click', map_render, false);
     }
}

function map_render(data,keys){
    separate_data(data,keys);
}

function separate_data(data,keys){
   console.log(get_data(data,keys));
   
}

function get_data(data,keys){
      console.log(keys);
      return JSON.stringify(data(keys).get());
}

function wrapper_parseRow(data,db){
    function parseRow(row){
    
      if(row.data[0][0] != ''){ // Trowing out entries without timestamp
        var elem = {};
        elem["type"]="Feature";
        var geom = {"type":"Point", 
                    "coordinates":[ row.data[0][19], row.data[0][20]]
                     };
        var properties = {"title":row.data[0][1], 
                          "icon": "harbor",
                          "message": get_message(row)};
        elem = get_categories(row.data[0][2],elem); // Categories
        elem["geojson"] = {"geometry": geom, "properties":properties};
        console.log(elem);
        db.insert(elem); 
	};
    };
    return parseRow
}


function get_message(row){
        return row.data[0][2]; 
}


function RemoveAccents(strAccents) {
		var strAccents = strAccents.split('');
		var strAccentsOut = new Array();
		var strAccentsLen = strAccents.length;
		var accents = 'ÀÁÂÃÄÅàáâãäåÒÓÔÕÕÖØòóôõöøÈÉÊËèéêëðÇçÐÌÍÎÏìíîïÙÚÛÜùúûüÑñŠšŸÿýŽž';
		var accentsOut = "aaaaaaaaaaaaoooooooooooooeeeeeeeeeccdiiiiiiiiuuuuuuuunnssyyyzz";
		for (var y = 0; y < strAccentsLen; y++) {
			if (accents.indexOf(strAccents[y]) != -1) {
				strAccentsOut[y] = accentsOut.substr(accents.indexOf(strAccents[y]), 1);
			} else
				strAccentsOut[y] = strAccents[y];
		}
		strAccentsOut = strAccentsOut.join('');
		return strAccentsOut;
}


function get_categories(line,elem){
    line = RemoveAccents(line);
    line = line.toLowerCase();
    line = line.replace(" ","");
    line = line.replace(",","");
    line = line.replace("-","");
    var otro = false;
    for (var i =0; i < n_categories-1; i++){
        if (line.search(categories[i])> -1){
           line = line.replace(categories[i], "");
           elem[categories[i]] = true;
        }
        else
           elem[categories[i]] = false;
     }
     if (line.legth != 0){
          line = line.replace(" ","");
          line = line.replace(",","");
          line = line.replace("-","");
          otro = true;
    }
    elem[categories[n_categories-1]] = otro;
    return elem
}

function classify(catkey,cat){
     return data_base({catkey:{is:cat}})
}

function get_Database(){
    return  getTableData();
}


function get_necesito(){
     return getin_out("Ofrezco/Necesito","Necesito");
}

function find(){
   all_data.necesito = {};
   all_data.ofrezco = {};
}

function all(){
   console.log(db({"comida":{is:true}}));
   //console.log(db({properties:{Comida:{is:true}}}));

}


var n_categories = 14;
var categories = ["comida","agua","refugio", "transporte","manosvoluntarios", "asistenciamedica","peritajes","articulosdelimpieza","medicamentos","carpas, tiendasdecampana","ropa","gasolina","otro"]; 

createdatabase();



// code from the next step will go here!
</script>

</body>
</html>
